
<project name="GEDprint" default="deploy">

  <property name="target" value="1.6"/>
  <property name="source" value="1.6"/>

  <target name="-init" depends="-macrodef">
    <property name="build.dir" value="build"/>
    <property name="javadoc.dir" value="docs/apidocs"/>
    <property name="deploy.dir" value="deploy"/>
    <property name="deploy.path" location="${deploy.dir}"/>

    <property name="main.class" value="net.sourceforge.gedprint.core.Startup"/>
    <property name="starter.jar" value="${deploy.dir}/GEDprint.jar"/>

    <xmlproperty file="sources.xml" collapseattributes="true"/>

  </target>
  
  <target name="deploy" depends="-init,jar,javadoc"
  	description="generates a zip files for deployment on a website">
  </target>

  <target name="clean" depends="-init"
  	description="cleans all generated files">
    <delete dir="${build.dir}"/>
    <delete dir="${deploy.dir}"/>
    <delete dir="${javadoc.dir}"/>
  </target>
  
  <target name="javadoc" depends="-init,compile"
  	description="generates apidocs for all source folders">
    <antcall target="-iterate">
      <param name="task" value="document"/>
    </antcall>
  </target>
  <target name="-iterate-next">
    <basename property="prefix" file="${basedir}"/>
    <antcall target="-iterate-${task}">
      <param name="basedir" value="${basedir.main}"/>
      <param name="source.${prefix}.location" value="src/${prefix}"/>
      <param name="source.${prefix}.build" value="${prefix}"/>
    </antcall>
  </target>

  <target name="-iterate-compile" depends="-init">
    <compile prefix="source.${prefix}" />
  </target>
  <target name="-iterate-document" depends="-init">
    <document prefix="source.${prefix}" />
  </target>
  <target name="-iterate-pack" depends="-init">
    <pack prefix="source.${prefix}" />
  </target>

  <target name="-iterate" depends="-init">
    <subant target="-iterate-next" genericantfile="build.xml"
      failonerror="false">
      <filelist dir="src" files="${source.buildpath}"/>
      <property name="basedir.main" value="${basedir}"/>
      <property name="task" value="${task}"/>
    </subant>
  </target>

  <target name="compile" depends="-init"
  	description="compiles all source files">
    <antcall target="-iterate">
      <param name="task" value="compile"/>
    </antcall>
  </target>

  <target name="jar" depends="-init,compile"
  	description="generates jar modules for all compiled sources">
    <mkdir dir="${deploy.dir}/lib"/>

    <antcall target="-iterate">
      <param name="task" value="pack"/>
    </antcall>

    <fileset dir="${deploy.dir}/lib" id="runtime.libs" includes="*.jar" />
    <pathconvert pathsep=" " dirsep="/"
        property="runtime.class.path" refid="runtime.libs">
      <map from="${deploy.path}/" to=""/>
    </pathconvert>
    <jar destfile="${starter.jar}">
      <manifest>
        <attribute name="Main-Class" value="${main.class}"/>
        <attribute name="Class-Path" value="${runtime.class.path}"/>
      </manifest>
    </jar>
  </target>

  <target name="-init-debug" depends="-init">
    <path id="runtime.classpath">
      <dirset dir="${build.dir}" includes="*"/>
    </path>
    <pathconvert refid="runtime.classpath"/>
  </target>
  <target name="debug" depends="-init,compile,-init-debug">
    <property name="debug.jvmargs" value=""/>
    <java dir="${basedir}" fork="true"
      classpathref="runtime.classpath"
      classname="${main.class}"
      >
      <jvmarg line="${debug.jvmargs}"/>
    </java>
  </target>

  <target name="-macrodef">

    <macrodef name="compile">
      <attribute name="prefix"/>
      <sequential>
        <!--echo message="deps=${@{prefix}.deps}"/-->
        <pathconvert property="@{prefix}.deps.path">
          <filelist dir="${build.dir}" files="${@{prefix}.deps}"/>
          <map from="${build.dir}" to=""/>
        </pathconvert>
        <!--echo message="classpath=${@{prefix}.deps.path}"/-->
        <mkdir dir="${build.dir}/${@{prefix}.build}"/>
        <javac srcdir="${@{prefix}.location}"
          source="${source}" target="${target}"
          destdir="${build.dir}/${@{prefix}.build}"
          classpath="${@{prefix}.deps.path}"
          debug="true" debuglevel="lines,vars,source"/>
        <copy todir="${build.dir}/${@{prefix}.build}">
          <fileset dir="${@{prefix}.location}" excludes="**/*.java"/>
        </copy>
      </sequential>
    </macrodef>

    <macrodef name="pack">
      <attribute name="prefix"/>
      <sequential>
        <jar basedir="${build.dir}/${@{prefix}.build}"
          destfile="${deploy.dir}/lib/${@{prefix}.deploy}.jar"/>
      </sequential>
    </macrodef>
    
    <macrodef name="document">
      <attribute name="prefix"/>
      <sequential>
        <pathconvert property="@{prefix}.deps.path">
          <filelist dir="${build.dir}" files="${@{prefix}.deps}"/>
        </pathconvert>
        <antcall target="-do-javadoc">
          <param name="javadoc.source" value="${@{prefix}.location}"/>
          <param name="javadoc.dest" value="${javadoc.dir}/${@{prefix}.build}"/>
          <param name="javadoc.classpath" value="${@{prefix}.deps.path}"/>
        </antcall>
      </sequential>
    </macrodef>

  </target>
  <target name="-javadoc-init">
    <mkdir dir="${javadoc.dest}"/>
    <uptodate targetfile="${javadoc.dest}/package-list"
          property="javadoc.uptodate">
      <srcfiles dir="${javadoc.source}" />
    </uptodate>
  </target>
  <target name="-do-javadoc" depends="-javadoc-init" unless="javadoc.uptodate">
    <javadoc sourcepath="${javadoc.source}"
          destdir="${javadoc.dest}"
          classpath="${javadoc.classpath}">
      <tag name="todo" scope="all"
        description="&lt;span style='background-color:orange;'&gt;Zu Erledigen:&lt;/span&gt;"/>
    </javadoc>
  </target>
</project>